<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>

<script type="text/x-thebe-config">
  {
    requestKernel: true,
    binderOptions: {
      repo: "QuantStack/ipycytoscape",
      ref: "1.2.0",
      repoProvider: "github",
    },
  }
</script>
<script src="https://unpkg.com/thebe@latest/lib/index.js"></script>
<style>
    pre{
        display: none;
        height: 100%;
        width: 75%;
    }
</style>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Configure Thebe
        // thebelab.bootstrap();
        var cellConfig = {
            "code": true,   // Allow execution of code cells
            "query": true   // Allow execution of query cells (for asking questions)
        };
        thebelab.bootstrap(cellConfig).then(thebelab.bootstrap());
        var buttonTitles = ['run this cell', 'restart the kernel', 'restart the kernel and run all cells'];
        // Find the buttons one by one and click or hide them
        for (let i = 0; i < buttonTitles.length; i++) {
            var button = document.querySelector('[title="'+buttonTitles[i]+'"]'); 
            console.log('button:',button)
            // If run button click the button
            if (i == 0){
                button.click();
                button.style.display = "none";
            }else{
                // else just remove
                button.style.display = "none";
            }
        }
    });
</script>
<html>
  <h1>Instructions</h1>
  <h2>Here are a few notes:</h2>
  <ul>
    <li>The app might take a few minutes to load, so please be patient.</li>
    <li>Left click on a node to go to deeper levels.</li>
    <li>Right click on any node to reset to the initial overview.</li>
    <li>Left click on the resource nodes will show the information regarding to it.</li>
        <li style="margin-left:2em">Left click again on the resource nodes to reveal the link to the respective webpages.</li>
  </ul>
  <pre hidden data-executable="true" data-language="python" data-readonly="true">
# Some more prerequisites, just run this
import networkx as nx
import pandas as pd
import json
from ipycytoscape import *
from pathlib import Path

#df_nodes = pd.read_csv(str('https://raw.githubusercontent.com/IGOR-bioDGPs/ARIADNE/master/testbook/data/data_ariadne_nodes.csv'), sep=';')
#df_edges = pd.read_csv(str('https://raw.githubusercontent.com/IGOR-bioDGPs/ARIADNE/master/testbook/data/data_ariadne_edges.csv'), sep=';')

url = 'https://docs.google.com/spreadsheets/d/1_QFjq-kAQfn_LFzRPwfP1G_yo2Kjc7z8vc61w_ZmN1o/gviz/tq?tqx=out:csv&sheet=sheet1'
df_nodes = pd.read_csv(url)
url = 'https://docs.google.com/spreadsheets/d/1o_KmX1LvN6dwk5kTvJDap-qUbEU9-axVW6HhhusI7ZA/gviz/tq?tqx=out:csv&sheet=sheet1'
df_edges = pd.read_csv(url)

df_nodes = df_nodes.fillna('')
df_edges = df_edges.fillna('')

# Import stuff to dynamically update the graph
from ipywidgets import Output
from IPython.display import display, Javascript, HTML

# graph constructor function
def const_graph(nodes_df, edges_df, init):
    # convert df to dicts
    nodes_dict = nodes_df.to_dict('records')
    edges_dict = edges_df.to_dict('records')
    # start building nodes
    data_keys = ['id', 'label', 'is_terminal', 'href', 'tooltip', 'descr'] # cyto logic
    rest_keys = ['score', 'idInt', 'name', 'score', 'group', 'removed', 'selected',
                 'selectable', 'locked', 'grabbed', 'grabbable'] # cyto extra logic
    nodes_graph_list = []
    # now loop over nodes
    for node in nodes_dict:
        dict_node = {}
        data_sub_dict = {'data':{el:node[el] for el in data_keys}} # get MUST data info
        rest_sub_dict = {el:node[el] for el in node.keys() if el in rest_keys} # get extra data info
        dict_node = {**data_sub_dict,**rest_sub_dict} # zip them
        nodes_graph_list.append(dict_node) # add to the list
    # start building edges
    data_keys  = ['id', 'source', 'target'] # cyto logic
    data_keys2 = ['label', 'classes'] # cyto logic
    rest_keys  = ['score', 'weight', 'group', 'networkId', 'networkGroupId', 'intn',
                  'rIntnId', 'group', 'removed', 'selected', 'selectable', 'locked',
                  'grabbed', 'grabbable', 'classes'] # cyto extra logic
    edges_graph_list = []
    # now loop over edges
    for edge in edges_dict:
        dict_edge = {}
        data_sub_dict = {el:edge[el] for el in data_keys} # get MUST data info
        data_sub_dict2 = {el:edge[el] for el in edge.keys() if el in data_keys2} # get MUST_2 data info
        rest_sub_dict = {el:edge[el] for el in edge.keys() if el in rest_keys} # get extra data info
        dict_edge = {'data':{**data_sub_dict,**data_sub_dict},**rest_sub_dict} # zip them
        edges_graph_list.append(dict_edge) # add to the list
    # create the combined edge+node dictionary
    total_graph_dict = {'nodes': nodes_graph_list, 'edges':edges_graph_list}
    # building the style
    all_node_style = ['background-color', 'background-opacity',
                     'font-family', 'font-size', 'label', 'width',
                     'shape', 'height', 'width', 'text-valign', 'text-halign', 'underlay-color' ,'underlay-shape']
    all_edge_style = ['background-color', 'background-opacity',
                     'font-family', 'font-size', 'label', 'width', 'line-color', 'arrow', 'type', 'target-arrow-shape']
    total_style_dict = {}
    style_elements = []
    # now construct the node styles
    for node in nodes_dict:
        node_dict = {'selector': f'node[id = \"{node["id"]}\"]'}
        style_dict ={"style": { el:node[el] for el in node.keys() if el in all_node_style}}
        node_dict.update(style_dict)
        style_elements.append(node_dict)
    # now construct the edge styles
    for edge in edges_dict:
        edge_dict = {'selector': f'edge[id = \"{edge["id"]}\"]'}
        style_dict = {"style": { el:edge[el] for el in edge.keys() if el in all_edge_style}}
        edge_dict.update(style_dict)
        style_elements.append(edge_dict)
    # now create the graph
    data_graph = json.dumps(total_graph_dict)
    json_to_python = json.loads(data_graph)
    # result_cyto = CytoscapeWidget()
    # for some reason ipycytoscape's function is not callable, so calling it manually
    cyto_graph.graph.nodes.clear()
    cyto_graph.graph.edges.clear()
    cyto_graph.graph._adj.clear()
    cyto_graph.graph.add_graph_from_json(json_to_python)
    cyto_graph.set_style(style_elements)
    # also save the initial json to a file
    if init:
        json_filename = 'init_config.json'
        style_filename = 'init_style.json'
        cyto_graph.set_layout(name = 'circle')
    else:
        json_filename = 'curr_config.json'
        style_filename = 'curr_style.json'
        dagre_layout_options = {
            'name': 'dagre',
            'nodeSpacing': 20,
            'edgeLengthVal': 100
        }
        cyto_graph.set_layout(layout=dagre_layout_options)
    with open(json_filename, 'w') as outfile:
        json.dump(json_to_python, outfile)
    with open(style_filename, 'w') as outfile:
        json.dump(json_to_python, outfile)
    # and return it
    #return result_cyto

# reset the graph
def res_graph(node):
    with out:
        # for some reason ipycytoscape's function is not callable, so calling it manually
        cyto_graph.graph.nodes.clear()
        cyto_graph.graph.edges.clear()
        cyto_graph.graph._adj.clear()
        const_graph(df_nodes[df_nodes['subgraph'] == 'initial'], df_edges[df_edges['subgraph'] == 'initial'], init=True)

def log_clicks(node):
    with out:
        new_nodes = df_nodes['subgraph'] == node['data']['id'].replace(' ','')
        new_edges = df_edges['subgraph'] == node['data']['id'].replace(' ','')
        curr_node_num = len(df_nodes[new_nodes])
        if node['data']['is_terminal'] == 'no':
            const_graph(df_nodes[new_nodes], df_edges[new_edges], init=False)
            cyto_graph.set_tooltip_source('')
        elif node['data']['is_terminal'] == 'yes':
            cyto_graph.set_tooltip_source('tooltip')
        if curr_node_num == 0 and node['data']['is_terminal'] == 'no':
            res_graph(node)

def hover_over(node):
    with out:
        cyto_graph.set_tooltip_source('descr')
        

# instantiate an jupyternotebook output
out = Output()
# instantiate a graph
cyto_graph = CytoscapeWidget(min_zoom=0.5, max_zoom=3.0) # ok now create the cytoscape object
cyto_graph.layout.height = '600px'
cyto_graph.layout.width = '1600px'
const_graph(df_nodes[df_nodes['subgraph'] == 'initial'], df_edges[df_edges['subgraph'] == 'initial'], init=True)

cyto_graph.on('node', 'click', log_clicks) # dynamically listen to left clicks
cyto_graph.on('node', 'cxttap', res_graph) # dynamically listen to right clicks
cyto_graph.on('node', 'mouseover', hover_over)

display(cyto_graph) # display the object
display(out) # display the output

</pre>
</html>
